export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

# If .nvmrc exists, request that version and try to locate the node binary via nvm
if [ -f .nvmrc ]; then
	NODE_VER=$(cat .nvmrc | tr -d "\n \r")
	nvm use --silent "$NODE_VER" >/dev/null 2>&1 || true
	# Try to resolve the real node binary for that version
	NODE_BIN=$(nvm which "$NODE_VER" 2>/dev/null || true)
else
	NODE_VER=""
	NODE_BIN=$(nvm which current 2>/dev/null || true)
fi

# If a node binary was found under $NVM_DIR, prepend its bin directory to PATH so it wins over asdf/homebrew
if [ -n "$NODE_BIN" ] && [ -f "$NODE_BIN" ]; then
	NODE_BIN_DIR=$(dirname "$NODE_BIN")
	# Remove asdf shim and asdf libexec entries from PATH in this directory session so nvm takes precedence
	# Note: this only modifies PATH for this direnv session and does not alter your global shell config.
	OLD_IFS="$IFS"
	IFS=:
	NEW_PATH_PARTS=()
	for p in $PATH; do
		# skip common asdf paths
		case "$p" in
			"$HOME/.asdf/shims"|"/opt/homebrew/opt/asdf/libexec/bin") continue ;;
			*) NEW_PATH_PARTS+=("$p") ;;
		esac
	done
	IFS="$OLD_IFS"
	# rebuild PATH without asdf entries and prepend the nvm node bin
	NEW_PATH="$NODE_BIN_DIR"
	for p in "${NEW_PATH_PARTS[@]}"; do
		NEW_PATH="$NEW_PATH:$p"
	done
	export PATH="$NEW_PATH"
fi

# Silence jsii warning about untested Node versions for this repo
export JSII_SILENCE_WARNING_UNTESTED_NODE_VERSION=1
